# ğŸš€ Mini Order System

A minimal Order Management microservice built with **FastAPI**, supporting authentication, role-based access, product management, order lifecycle management, pagination, filtering, and concurrency-safe stock handling.

---

## âœ¨ Features

- JWT Authentication
- Role-Based Access (Admin / Customer)
- Product Management (CRUD)
- Order Lifecycle (PENDING â†’ CONFIRMED â†’ CANCELLED)
- Stock Validation
- Concurrency Handling (Prevents Overselling)
- Pagination & Filtering
- SQLite (Development DB)
- Docker Support
- Clean Modular Architecture

---

## ğŸ›  Prerequisites

- Python 3.10+
- `uv` (Python package manager)
- Optional: Docker

---

## âš¡ Setup & Run (Using uv)

### 1ï¸âƒ£ Install uv (if not installed)

**Windows (PowerShell)**

```powershell
pip install uv
```

OR

```powershell
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**Mac / Linux**

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

Verify:

```bash
uv --version
```

---

### 2ï¸âƒ£ Install Dependencies

```bash
uv sync
```

---

### 3ï¸âƒ£ Run Application

```bash
uv run uvicorn app.main:app --reload
```

Production mode:

```bash
uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

---

## ğŸ“˜ API Documentation

Open Swagger UI:

```
http://127.0.0.1:8000/docs
```

---

# ğŸ” API Execution Flow

## 1ï¸âƒ£ Register Users

```
POST /register
```

Admin:
```json
{
  "username": "admin1",
  "password": "1234",
  "role": "admin"
}
```

Customer:
```json
{
  "username": "customer1",
  "password": "1234",
  "role": "customer"
}
```

---

## 2ï¸âƒ£ Login

```
POST /login
```

Use returned token in Swagger:

```
Bearer YOUR_TOKEN
```

---

## 3ï¸âƒ£ Create Product (Admin Only)

```
POST /products
```

---

## 4ï¸âƒ£ List Products

```
GET /products?page=1&limit=10
```

---

## 5ï¸âƒ£ Place Order (Customer)

```
POST /orders
```

---

## 6ï¸âƒ£ Confirm Order (Admin)

```
PATCH /orders/{order_id}/confirm
```

---

## 7ï¸âƒ£ Cancel Order

```
PATCH /orders/{order_id}/cancel
```

---

# ğŸ”’ Concurrency Handling

Concurrency is handled using:

```
.with_for_update()
```

Inside a database transaction.

### How It Works:

- First request locks product row
- Stock is validated and reduced
- Transaction commits
- Second request waits for lock release
- Second request reads updated stock
- If insufficient â†’ order fails

This prevents overselling.

---

# ğŸ— Architecture Overview

```
Client â†’ API Router â†’ Service Layer â†’ Database
```

### Project Structure

```
app/
â”œâ”€â”€ api/        # Routers
â”œâ”€â”€ core/       # Security
â”œâ”€â”€ db/         # DB config
â”œâ”€â”€ models/     # ORM models
â”œâ”€â”€ schemas/    # Pydantic schemas
â”œâ”€â”€ services/   # Business logic
â”œâ”€â”€ main.py     # Entry point
```

---

# ğŸ“¦ Assumptions

- SQLite used for development.
- Replace with PostgreSQL for production.
- Background jobs should use a task queue in production.
